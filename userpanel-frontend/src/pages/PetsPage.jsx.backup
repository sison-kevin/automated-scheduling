import { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import api from '../api';

function PetsPage() {
  const { user, logout } = useAuth();
  const [pets, setPets] = useState([]);
  const [showAddModal, setShowAddModal] = useState(false);
  const [showEditModal, setShowEditModal] = useState(false);
  const [formData, setFormData] = useState({
    id: '',
    name: '',
    species: '',
    breed: '',
    birthdate: '',
    age: '',
    vaccinated: '1',
    medical_history: '',
    photo: null
  });

  useEffect(() => {
    fetchPets();
  }, []);

  const fetchPets = async () => {
    try {
      const response = await api.get('/pets');
      setPets(response.data.pets || []);
    } catch (error) {
      console.error('Error fetching pets:', error);
    }
  };

  const calculateAge = (birthdate) => {
    if (!birthdate) return '';
    
    const birth = new Date(birthdate);
    const today = new Date();
    
    let years = today.getFullYear() - birth.getFullYear();
    let months = today.getMonth() - birth.getMonth();
    let days = today.getDate() - birth.getDate();
    
    if (days < 0) {
      months--;
      days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
    }
    if (months < 0) {
      years--;
      months += 12;
    }
    
    let ageStr = '';
    if (years > 0) {
      ageStr = years + ' year' + (years > 1 ? 's' : '');
      if (months > 0) {
        ageStr += ' ' + months + ' month' + (months > 1 ? 's' : '');
      }
    } else if (months > 0) {
      ageStr = months + ' month' + (months > 1 ? 's' : '');
    } else {
      ageStr = days + ' day' + (days > 1 ? 's' : '');
    }
    
    return ageStr;
  };

  const handleChange = (e) => {
    const { name, value, files } = e.target;
    if (name === 'photo') {
      setFormData({ ...formData, photo: files[0] });
    } else {
      setFormData({ ...formData, [name]: value });
      if (name === 'birthdate') {
        setFormData({ ...formData, birthdate: value, age: calculateAge(value) });
      }
    }
  };

  const handleAddSubmit = async (e) => {
    e.preventDefault();
    try {
      const data = new FormData();
      Object.keys(formData).forEach(key => {
        if (key !== 'id' && formData[key]) {
          data.append(key, formData[key]);
        }
      });
      await api.post('/pets/add', data);
      setShowAddModal(false);
      setFormData({ id: '', name: '', species: '', breed: '', birthdate: '', age: '', vaccinated: '1', medical_history: '', photo: null });
      fetchPets();
    } catch (error) {
      console.error('Error adding pet:', error);
    }
  };

  const handleEditSubmit = async (e) => {
    e.preventDefault();
    try {
      const data = new FormData();
      Object.keys(formData).forEach(key => {
        if (formData[key]) {
          data.append(key, formData[key]);
        }
      });
      await api.post('/pets/update', data);
      setShowEditModal(false);
      fetchPets();
    } catch (error) {
      console.error('Error updating pet:', error);
    }
  };

  const openEditModal = (pet) => {
    setFormData({
      id: pet.id,
      name: pet.name,
      species: pet.species || '',
      breed: pet.breed,
      birthdate: pet.birthdate || '',
      age: pet.age || '',
      vaccinated: pet.vaccinated ? '1' : '0',
      medical_history: pet.medical_history || '',
      photo: null
    });
    setShowEditModal(true);
  };

  const handleDelete = async (id) => {
    if (window.confirm('Delete this pet?')) {
      try {
        await api.post(`/pets/delete/${id}`);
        fetchPets();
      } catch (error) {
        console.error('Error deleting pet:', error);
      }
    }
  };

  return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
          --primary: #ff914d;
          --primary-light: #ffb47b;
          --accent: #fff4ed;
          --bg: #f8fafc;
          --card: #ffffff;
          --text-dark: #222;
          --text-muted: #666;
          --border: #e6e8ec;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
          font-family: 'Inter', sans-serif;
          background: var(--bg);
          color: var(--text-dark);
          transition: 0.3s ease all;
        }

        header {
          position: sticky;
          top: 0;
          background: rgba(255, 255, 255, 0.9);
          backdrop-filter: blur(12px);
          box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 18px 50px;
          z-index: 100;
        }

        header h1 {
          font-weight: 700;
          font-size: 1.4rem;
          color: var(--primary);
          letter-spacing: 0.2px;
        }

        .user-info {
          font-size: 0.9rem;
          color: var(--text-muted);
        }

        .btn {
          background: var(--primary);
          color: #fff;
          padding: 10px 20px;
          border-radius: 10px;
          font-weight: 600;
          text-decoration: none;
          transition: 0.3s ease all;
          box-shadow: 0 4px 12px rgba(255, 145, 77, 0.3);
          border: none;
          cursor: pointer;
        }

        .btn:hover {
          background: var(--primary-light);
          transform: translateY(-2px);
        }

        .dashboard {
          display: grid;
          grid-template-columns: 250px 1fr;
          min-height: 100vh;
        }

        .sidebar {
          background: var(--card);
          padding: 40px 25px;
          border-right: 1px solid var(--border);
          box-shadow: 3px 0 15px rgba(0, 0, 0, 0.05);
          display: flex;
          flex-direction: column;
        }

        .sidebar h3 {
          color: var(--primary);
          font-weight: 700;
          text-align: center;
          margin-bottom: 35px;
        }

        .sidebar a {
          padding: 12px 16px;
          border-radius: 8px;
          color: var(--text-dark);
          font-weight: 500;
          text-decoration: none;
          transition: all 0.3s ease;
          margin-bottom: 10px;
        }

        .sidebar a:hover,
        .sidebar a.active {
          background: linear-gradient(135deg, var(--primary), var(--primary-light));
          color: white;
          box-shadow: 0 4px 16px rgba(255, 145, 77, 0.25);
          transform: translateX(5px);
        }

        .main-content {
          padding: 50px 70px;
          animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }

        .card {
          background: var(--card);
          border-radius: 16px;
          padding: 35px;
          margin-bottom: 40px;
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
          transition: all 0.3s ease;
        }

        .card:hover {
          transform: translateY(-3px);
          box-shadow: 0 12px 32px rgba(0, 0, 0, 0.08);
        }

        .card h2 {
          color: var(--primary);
          margin-bottom: 10px;
          font-size: 1.5rem;
        }

        .card p {
          color: var(--text-muted);
        }

        .pets-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
          gap: 30px;
          margin-top: 30px;
        }

        .pet-card {
          background: var(--card);
          border-radius: 14px;
          box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
          padding: 25px;
          text-align: center;
          transition: 0.3s ease;
          border: 1px solid var(--border);
        }

        .pet-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 10px 30px rgba(255, 145, 77, 0.2);
        }

        .pet-card img {
          width: 110px;
          height: 110px;
          border-radius: 50%;
          border: 3px solid var(--primary);
          object-fit: cover;
          margin-bottom: 15px;
        }

        .pet-card h4 {
          color: var(--primary);
          margin-bottom: 5px;
          font-size: 1.1rem;
        }

        .pet-card p {
          font-size: 0.9rem;
          color: var(--text-muted);
          margin: 3px 0;
        }

        .actions a {
          display: inline-block;
          padding: 7px 12px;
          border-radius: 6px;
          font-size: 0.85rem;
          text-decoration: none;
          font-weight: 600;
          transition: 0.3s ease;
          margin: 4px;
          cursor: pointer;
        }

        .actions .edit {
          background: #ffe5b4;
          color: #333;
        }

        .actions .delete {
          background: #ff6b6b;
          color: #fff;
        }

        .actions a:hover {
          opacity: 0.9;
          transform: translateY(-2px);
        }

        .overlay {
          position: fixed;
          top: 0; left: 0;
          width: 100vw; height: 100vh;
          background: rgba(255, 255, 255, 0.4);
          backdrop-filter: blur(8px);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 999;
          animation: fadeIn 0.3s ease;
        }

        .overlay.active { display: flex; }

        .form-card {
          background: rgba(255, 255, 255, 0.9);
          padding: 35px;
          border-radius: 18px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          width: 420px;
          position: relative;
          animation: fadeIn 0.4s ease;
        }

        .form-card h3 {
          text-align: center;
          color: var(--primary);
          font-size: 1.4rem;
          margin-bottom: 20px;
        }

        form label {
          display: block;
          margin-top: 12px;
          font-weight: 600;
          color: var(--text-dark);
        }

        form input, form select, form textarea {
          width: 100%;
          padding: 10px;
          margin-top: 6px;
          border-radius: 8px;
          border: 1px solid var(--border);
          outline: none;
          font-size: 0.95rem;
          transition: 0.3s;
        }

        form input:focus, form select:focus, form textarea:focus {
          border-color: var(--primary);
          box-shadow: 0 0 0 3px rgba(255, 145, 77, 0.2);
        }

        form button {
          background: var(--primary);
          color: white;
          padding: 12px;
          border: none;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          margin-top: 20px;
          width: 100%;
          transition: 0.3s;
          box-shadow: 0 4px 12px rgba(255, 145, 77, 0.25);
        }

        form button:hover {
          background: var(--primary-light);
          transform: translateY(-2px);
        }

        .close-btn {
          position: absolute;
          top: 10px;
          right: 16px;
          background: none;
          border: none;
          font-size: 1.5rem;
          color: var(--text-muted);
          cursor: pointer;
          transition: 0.3s;
        }

        .close-btn:hover {
          color: var(--primary);
          transform: scale(1.1);
        }

        footer {
          text-align: center;
          padding: 20px;
          color: var(--text-muted);
          font-size: 0.9rem;
          border-top: 1px solid var(--border);
          background: var(--card);
        }

        @media (max-width: 900px) {
          .dashboard { grid-template-columns: 1fr; }
          .sidebar {
            flex-direction: row;
            justify-content: center;
            border-bottom: 1px solid var(--border);
          }
          .main-content { padding: 30px 20px; }
        }
      `}</style>

      <header>
        <div>
          <h1>Veterinary Services Dashboard</h1>
          <div className="user-info">
            {user?.name || 'User'} | {user?.email || ''}
          </div>
        </div>
        <button onClick={logout} className="btn">Logout</button>
      </header>

      <div className="dashboard">
        <aside className="sidebar">
          <h3>Navigation</h3>
          <Link to="/landing">Landing Page</Link>
          <Link to="/dashboard">Dashboard</Link>
          <Link to="/dashboard/appointments">Appointments</Link>
          <Link to="/dashboard/pets" className="active">Pets</Link>
          <Link to="/dashboard/veterinarians">Veterinarians</Link>
          <Link to="/dashboard/settings">Settings</Link>
        </aside>

        <section className="main-content">
          <div className="card">
            <h2>My Pets</h2>
            <p>Manage your pets' profiles and health history here.</p>
            <button className="btn" onClick={() => setShowAddModal(true)}>Add New Pet</button>

            {pets.length > 0 ? (
              <div className="pets-grid">
                {pets.map(pet => (
                  <div key={pet.id} className="pet-card">
                    <img 
                      src={pet.photo ? `http://localhost/userpanel-event/userpanel-backend/${pet.photo}` : 'http://localhost/userpanel-event/userpanel-backend/assets/default-pet.png'} 
                      alt={pet.name} 
                    />
                    <h4>{pet.name}</h4>
                    <p><strong>Species:</strong> {pet.species || 'N/A'}</p>
                    <p><strong>Breed:</strong> {pet.breed}</p>
                    <p><strong>Age:</strong> {pet.age || 'Unknown'}</p>
                    <p><strong>Vaccinated:</strong> {pet.vaccinated ? 'Yes' : 'No'}</p>
                    <p><strong>Medical History:</strong> {pet.medical_history || 'None'}</p>

                    <div className="actions">
                      <a className="edit" onClick={() => openEditModal(pet)}>Edit</a>
                      <a className="delete" onClick={() => handleDelete(pet.id)}>Delete</a>
                      <div style={{ marginTop: '12px' }}>
                        <img 
                          src={`http://localhost/userpanel-event/userpanel-backend/pets/qr/${pet.id}`} 
                          alt="QR Code" 
                          width="100" 
                          height="100" 
                          style={{ border: '1px solid #ccc', borderRadius: '6px' }}
                        />
                        <br />
                        <small style={{ color: '#666', fontSize: '0.7rem' }}>Pet ID: {pet.id}</small><br />
                        <a href={`http://localhost/userpanel-event/userpanel-backend/pets/download-qr/${pet.id}`} className="btn" style={{ marginTop: '5px', padding: '5px 10px', fontSize: '0.8rem' }}>Download QR</a>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div style={{ background: '#fff8f3', padding: '15px', borderLeft: '5px solid var(--primary)', borderRadius: '8px', marginTop: '20px' }}>
                You haven't added any pets yet.
              </div>
            )}
          </div>
        </section>
      </div>

      {/* Add Pet Modal */}
      <div className={`overlay ${showAddModal ? 'active' : ''}`}>
        <div className="form-card">
          <button className="close-btn" onClick={() => setShowAddModal(false)}>&times;</button>
          <h3>Add New Pet</h3>
          <form onSubmit={handleAddSubmit}>
            <label htmlFor="name">Pet Name</label>
            <input type="text" id="name" name="name" value={formData.name} onChange={handleChange} required />
            
            <label htmlFor="species">Species</label>
            <input type="text" id="species" name="species" value={formData.species} onChange={handleChange} required />
            
            <label htmlFor="breed">Breed</label>
            <input type="text" id="breed" name="breed" value={formData.breed} onChange={handleChange} required />
            
            <label htmlFor="birthdate">Birthdate</label>
            <input type="date" id="birthdate" name="birthdate" value={formData.birthdate} onChange={handleChange} />
            
            <label htmlFor="age">Age</label>
            <input type="text" id="age" name="age" value={formData.age} readOnly />
            
            <label htmlFor="vaccinated">Vaccinated</label>
            <select id="vaccinated" name="vaccinated" value={formData.vaccinated} onChange={handleChange}>
              <option value="1">Yes</option>
              <option value="0">No</option>
            </select>
            
            <label htmlFor="medical_history">Medical History</label>
            <textarea id="medical_history" name="medical_history" rows="3" value={formData.medical_history} onChange={handleChange}></textarea>
            
            <label htmlFor="photo">Photo</label>
            <input type="file" id="photo" name="photo" accept="image/*" onChange={handleChange} />
            
            <button type="submit">Save Pet</button>
          </form>
        </div>
      </div>

      {/* Edit Pet Modal */}
      <div className={`overlay ${showEditModal ? 'active' : ''}`}>
        <div className="form-card">
          <button className="close-btn" onClick={() => setShowEditModal(false)}>&times;</button>
          <h3>Edit Pet</h3>
          <form onSubmit={handleEditSubmit}>
            <input type="hidden" name="id" value={formData.id} />
            
            <label htmlFor="edit_name">Pet Name</label>
            <input type="text" id="edit_name" name="name" value={formData.name} onChange={handleChange} required />
            
            <label htmlFor="edit_species">Species</label>
            <input type="text" id="edit_species" name="species" value={formData.species} onChange={handleChange} required />
            
            <label htmlFor="edit_breed">Breed</label>
            <input type="text" id="edit_breed" name="breed" value={formData.breed} onChange={handleChange} required />
            
            <label htmlFor="edit_birthdate">Birthdate</label>
            <input type="date" id="edit_birthdate" name="birthdate" value={formData.birthdate} onChange={handleChange} />
            
            <label htmlFor="edit_age">Age</label>
            <input type="text" id="edit_age" name="age" value={formData.age} readOnly />
            
            <label htmlFor="edit_vaccinated">Vaccinated</label>
            <select id="edit_vaccinated" name="vaccinated" value={formData.vaccinated} onChange={handleChange}>
              <option value="1">Yes</option>
              <option value="0">No</option>
            </select>
            
            <label htmlFor="edit_medical_history">Medical History</label>
            <textarea id="edit_medical_history" name="medical_history" rows="3" value={formData.medical_history} onChange={handleChange}></textarea>
            
            <label htmlFor="edit_photo">Photo</label>
            <input type="file" id="edit_photo" name="photo" accept="image/*" onChange={handleChange} />
            
            <button type="submit">Update Pet</button>
          </form>
        </div>
      </div>

      <footer>
        &copy; {new Date().getFullYear()} Automated Scheduling and Tracking System for Veterinary Services â€“ Calapan City, Oriental Mindoro
      </footer>
    </>
  );
}

export default PetsPage;
